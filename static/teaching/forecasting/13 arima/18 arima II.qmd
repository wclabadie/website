---
title: "ARIMA II"
author: "BUS 323 Forecasting and Risk Analysis"
format: 
  revealjs:
    theme: simple
    incremental: true
    html-math-method: mathjax
editor: visual
---

## Moving average models
* Uses past forecast errors:
<div class="fragment">
$$
y_{t} = c + \epsilon_{t} + \theta_{1} \epsilon_{t-1} + \theta_{2} \epsilon_{t-2} + ... + \theta_{q} \epsilon_{t-q}
$$
</div>
    + Where $\epsilon_{t}$ is white noise.
* The above is a **MA(q) model**. 

## Moving average models: simulation
* Suppose we have two models:
    + MA(1): $y_{t} = 20 + \epsilon_{t} + 0.8 \epsilon_{t-1}$.
    + MA(2): $y_{t} = \epsilon_{t} - \epsilon_{t-1} + 0.8 \epsilon_{t-2}$.
* Generate the MA process for each model based on the following observed values of $\epsilon_{t}$:

<div class="fragment">
| Period | $\epsilon$ |
|--------|------------|
|1       |1.712.      |
|2.      |-1.514.     |
|3.      |0.948.      |
|4.      |-1.518.     |
|5.      |-0.212.     |
</div>

## Moving average models: simulation II
* Suppose we have two models:
    + MA(1): $y_{t} = 20 + \epsilon_{t} + 0.8 \epsilon_{t-1}$.
    + MA(2): $y_{t} = \epsilon_{t} - \epsilon_{t-1} + 0.8 \epsilon_{t-2}$.
* Make a 50-observation vector containing white noise. Estimate both of the above MA models.
```{r}
#| echo: true
#| output: true
#| classes: fragment
library(fpp3)
errors <- rnorm(50,0,1)
ma1 <- c(rep(20,length(errors))) + errors + 0.8*difference(errors)
ma2 <- errors - difference(errors) + 0.8*difference(errors,2)
```

## Moving average models: simulation II plot
* Plot the models:
```{r}
#| echo: false
#| output: true
#| classes: fragment
df <- data.frame(
  t = 1:length(errors),
  MA1 = ma1,
  MA2 = ma2
  ) %>%
  pivot_longer(cols = c(MA1, MA2), names_to = "Model", values_to = "Value")

ggplot(df, aes(x = t, y = Value, color = Model)) +
  geom_line() +
  labs(title = "MA(1) vs MA(2) series",
       x = "Period",
       y = "y") +
  theme_minimal() +
  scale_color_manual(values = c("MA1" = "blue", "MA2" = "orange"))
```

## Invertibility
* Any AR(p) model can be expressed as an MA($\infty$) model. 
* e.g. for an AR(1):
<div class="fragment">
$$ 
\begin{align} 
y_{t} & = \phi_{1} y_{t-1} + \epsilon_{t} \\
& = \phi_{1}(\phi_{1} y_{t-2} + \epsilon_{t-1}) + \epsilon_{t-1} \\
& = \phi_{1}^{2} y_{t-2} + \phi_{1} \epsilon_{t-1}+ \epsilon_{t} \\
& = \phi_{1}^{2}(\phi_{1} y_{t-3} + \epsilon_{t-2}) + \phi_{1} \epsilon_{t-1} + \epsilon_{t} \\
& = \phi_{1}^{3} y_{t-3} + \phi_{1}^{2} \epsilon_{t-2} + \phi_{1} \epsilon_{t-1} + \epsilon_{t} \\
\textrm{etc.}
\end{align}
$$
</div>
* For $-1 < \phi_{1} < 1$, $\phi_{1}^{k}$ decreasing with $k$. 
    + In the limit,
<div class="fragment">
$$
y_{t} = \epsilon_{t} + \phi_{1} \epsilon_{t-1} + \phi_{1}^{2} \epsilon_{t-2} + \phi_{1}^{3} \epsilon_{t-3} + ...
$$
</div>
    + An MA($\infty$) process.

## ARIMA models
* Combine differencing, autoregression, and moving average models:
<div class="fragment">
$$
\begin{align}
y_{t}' = & c + \phi y_{t-1}' + ... + \phi_{p} y_{t-p}' \\
& + \theta_{1} \epsilon_{t-1} + ... + \theta_{1} \epsilon_{t-q} + \epsilon_{t}
\end{align}
$$
</div>
    + The above is an **ARIMA(p,d,q) model**

## Example: Egyptian exports
* From `global_economy`:
```{r}
#| echo: false
#| output: true
#| classes: fragment
global_economy |>
  filter(Code == "EGY") |>
  autoplot(Exports) +
  labs(y = "% of GDP", title = "Egyptian exports")
```

## Example: Egyptian exports
* Use `ARIMA()` to automatically select appropriate values for $p$, $d$, and $q$:
```{r}
#| echo: true
#| output: true
#| classes: fragment
fit <- global_economy |>
  filter(Code == "EGY") |>
  model(ARIMA(Exports))
report(fit)
```

## Example: Egyptian exports
* Forecast 10 years into the future:
```{r}
#| echo: true
#| output: false
#| classes: fragment
fit |> forecast(h=10) |>
  autoplot(global_economy) +
  labs(y = "% of GDP", title = "Egyptian exports")
```

## Example: Egyptian exports
```{r}
#| echo: false
#| output: true
#| classes: fragment
fit |> forecast(h=10) |>
  autoplot(global_economy) +
  labs(y = "% of GDP", title = "Egyptian exports")
```

## Notable parameter values
* If $c=0$ and $d=0$, forecasts $\rightarrow$ 0.
* If $c=0$ and $d=1$, forecasts $\rightarrow$ non-zero constant.
* If $c=0$ and $d=2$, forecasts $\rightarrow$ straight line.
* If $c \neq 0$ and $d=0$, forecasts $\rightarrow \bar{y}$.
* If $c \neq 0$ and $d=1$, forecasts $\rightarrow$ straight line.
* If $c \neq 0$ and $d=2$, forecasts $\rightarrow$ quadratic trend (this is bad)
* To obtain cyclic forecasts, $p \geq 2$.


